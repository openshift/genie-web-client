#!/usr/bin/env sh

# Run ESLint on entire codebase (not just staged files)
echo "Running ESLint on entire codebase..."
yarn eslint src integration-tests
if [ $? -ne 0 ]; then
  echo "❌ ESLint failed. Please fix the errors above."
  exit 1
fi
echo "✅ ESLint passed"

# Run Stylelint on entire codebase
echo ""
echo "Running Stylelint on entire codebase..."
yarn stylelint 'src/**/*.css' --allow-empty-input
if [ $? -ne 0 ]; then
  echo "❌ Stylelint failed. Please fix the errors above."
  exit 1
fi
echo "✅ Stylelint passed"

# Run TypeScript type checking
echo ""
echo "Running TypeScript type check..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "❌ TypeScript check failed. Please fix the errors above."
  exit 1
fi
echo "✅ TypeScript passed"

# Run tests related to staged files
echo ""
echo "Running tests for staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' | tr '\n' ' ')
if [ -n "$STAGED_FILES" ]; then
  npx jest --passWithNoTests --findRelatedTests $STAGED_FILES
  if [ $? -ne 0 ]; then
    echo "❌ Tests failed. Please fix the errors above."
    exit 1
  fi
  echo "✅ Tests passed"
else
  echo "⏭️  No staged source files to test (skipped)"
fi

echo ""
echo "✅ All pre-commit checks passed!"
