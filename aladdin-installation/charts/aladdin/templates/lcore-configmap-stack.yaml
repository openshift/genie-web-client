{{- if .Values.lightspeedCore.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.lightspeedCore.stackConfigMapName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "aladdin.lightspeedCore.labels" . | nindent 4 }}
data:
  lightspeed-stack.yaml: |
    name: Lightspeed Core Service (LCS)
    service:
      log_level: "info"
      host: 0.0.0.0
      port: {{ .Values.lightspeedCore.containerPort }}
      tls_config:
        tls_certificate_path: "/opt/app-root/certs/tls.crt"
        tls_key_path: "/opt/app-root/certs/tls.key"
      workers: 1
      color_log: true
      access_log: true
    llama_stack:
      use_as_library_client: true
      library_client_config_path: /opt/app-root/run.yaml
    user_data_collection:
      feedback_enabled: true
      feedback_storage: "/tmp/data/feedback"
      transcripts_enabled: true
      transcripts_storage: "/tmp/data/transcripts"
    authentication:
      module: "k8s"
    conversation_cache:
      type: "sqlite"
      sqlite:
        db_path: "/tmp/data/conversation-cache.db"
    inference:
      default_model: {{ .Values.lightspeedCore.models.modelId }}
      default_provider: {{ .Values.lightspeedCore.models.providerId }}
    mcp_servers:
      {{- range .Values.lightspeedCore.mcpServers }}
      - name: {{ .name | quote }}
        provider_id: "model-context-protocol"
        url: {{ .url | quote }}
        {{- if .authorization_headers }}
        authorization_headers:
          {{- range $key, $value := .authorization_headers }}
          {{ $key }}: {{ $value | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    customization:
      system_prompt: |
{{ .Files.Get "files/prompts/system-prompt.txt" | indent 8 }}
{{- end }}
